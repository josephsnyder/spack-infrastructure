---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: gitlab-temp
  namespace: gitlab
spec:
  releaseName: gitlab-temp
  chart:
    name: gitlab
    repository: https://charts.gitlab.io
    version: 3.2.2 # gitlab@12.9.2

  values:
    nodeSelector:
      spack.io/node-pool: base

    global:
      operator:
        enabled: false

      edition: ee

      hosts:
        domain: next.spack.io
        https: true
        gitlab:
          name: gitlab.next.spack.io
        minio:
          name: minio.next.spack.io
        registry:
          name: registry.next.spack.io

      ingress:
        configureCertmanager: false
        class: nginx

      gitlab:
        license: {}

      ## doc/charts/globals.md#configure-postgresql-settings
      ## psql:
      ##   password:
      ##     secret: gitlab-secrets
      ##     key: gitlab-db-password
      ##   host: r001-spack-gitlab.cgnbnwwuxkgt.us-east-1.rds.amazonaws.com
      ##   username: gitlab
      ##   database: gitlabhq_production

      ## doc/charts/globals.md#configure-redis-settings
      ## redis:
      ##   password:
      ##     enabled: false
      ##   host: r003-spack-gitlab.cev8lh.clustercfg.use1.cache.amazonaws.com

      ## doc/charts/globals.md#configure-minio-settings
      ## NOTE(opadron): in the older version of this chart, this section is
      ##                moved to the root
      ## minio:
      ##   ingress:
      ##     tls:
      ##       secretName: tls-gitlab-minio

      ## doc/charts/globals.md#configure-grafana-integration
      grafana:
        enabled: false

      ## doc/charts/globals.md#configure-registry-settings
      ## NOTE(opadron): in the older version of this chart, this section is
      ##                moved to the root
      ## registry:
      ##   ingress:
      ##     tls:
      ##       secretName: tls-gitlab-registry

      ## GitLab Runner
      ## Secret created according to doc/installation/secrets.md#gitlab-runner-secret
      ## If allowing shared-secrets generation, this is OPTIONAL.
      runner:
          install: false

      ## smtp:
      ##   enabled: false

    certmanager:
      install: false

    nginx-ingress:
      enabled: false

    prometheus:
      install: false

    ## redis:
    ## install: false

    ## postgresql:
    ##   install: false

    ## doc/charts/globals.md#configure-minio-settings
    ## NOTE(opadron): this is where the minio section is in the old version of
    ##                this chart.
    minio:
      ingress:
        tls:
          secretName: tls-gitlab-minio-temp
      nodeSelector:
        spack.io/node-pool: base

    ## doc/charts/globals.md#configure-registry-settings
    ## NOTE(opadron): this is where the registry section is in the old version of
    ##                this chart.
    registry:
      ingress:
        tls:
          secretName: tls-gitlab-registry-temp
      nodeSelector:
        spack.io/node-pool: base

    gitlab-runner:
      install: false

    gitlab:
      ingress:
        tls:
          enabled: true
      unicorn:
        ingress:
          tls:
            secretName: tls-gitlab-unicorn-temp
        replicaCount: 4
        nodeSelector:
          spack.io/node-pool: base

      gitlab-exporter:
        nodeSelector:
          spack.io/node-pool: base

      gitlab-shell:
        nodeSelector:
          spack.io/node-pool: base

      sidekiq:
        nodeSelector:
          spack.io/node-pool: base

      task-runner:
        nodeSelector:
          spack.io/node-pool: base

      unicorn:
        nodeSelector:
          spack.io/node-pool: base

      gitaly:
        nodeSelector:
          spack.io/node-pool: base

      migrations:
        nodeSelector:
          spack.io/node-pool: base

    gitaly:
      nodeSelector:
        spack.io/node-pool: base

    gitlab-shell:
      nodeSelector:
        spack.io/node-pool: base

    gitlab-grafana:
      nodeSelector:
        spack.io/node-pool: base

    postgresql:
      nodeSelector:
        spack.io/node-pool: base

    redis:
      nodeSelector:
        spack.io/node-pool: base

    shared-secrets:
      nodeSelector:
        spack.io/node-pool: base
